# Example of a YAML configuration file for a BioExcel building blocks workflow

working_dir_path: output          # Folder to write i/o files of the workflow steps
can_write_console_log: False      # Verbose writing of log information
restart: True                     # Skip steps already performed

# Step 1: extraction of protein and structure Check

step1A_pdb:
  paths:
    output_pdb_path: structure.pdb
  properties:
    filter: False                 # [ATOM, MODEL, ENDMDL] or False (then extract protein)
    pdb_code: 4LOO

step1B_extractMolecule:
  paths:
    input_structure_path: dependency/step1A_pdb/output_pdb_path
    output_molecule_path: protein.pdb
  properties:
    molecule_type: chains            # (all), protein, na, dna, rna, chains
    chains: [A]                      # None or [A, B]

# Step 2: addition of mutations and fix PDB defects 

step2A_fixaltlocs:
  paths:
    input_pdb_path: dependency/step1B_extractMolecule/output_molecule_path
    output_pdb_path: fixaltlocs.pdb

step2B_mutations:
  paths:
    input_pdb_path: dependency/step2A_fixaltlocs/output_pdb_path
    output_pdb_path: mutated.pdb

step2C_fixbackbone:
  paths:
    input_pdb_path: dependency/step2B_mutations/output_pdb_path
    input_fasta_canonical_sequence_path: canonical.fasta
    output_pdb_path: fixbackbone.pdb
  properties:
    add_caps: False
    modeller_key: MODELIRANJE

step2D_fixsidechain:
  paths:
    input_pdb_path: dependency/step2C_fixbackbone/output_pdb_path
    output_pdb_path: fixsidechain.pdb

step2E_fixssbonds:
  paths:
    input_pdb_path: dependency/step2D_fixsidechain/output_pdb_path
    output_pdb_path: fixssbonds.pdb

step2F_fixamides:
  paths:
    input_pdb_path: dependency/step2E_fixssbonds/output_pdb_path
    output_pdb_path: fixamides.pdb

step2G_fixchirality:
  paths:
    input_pdb_path: dependency/step2F_fixamides/output_pdb_path
    output_pdb_path: fixchirality.pdb

step2H_renumberstructure:
  paths:
    input_structure_path: dependency/step2G_fixchirality/output_pdb_path
    output_structure_path: renumbered.pdb
    output_mapping_json_path: mapping.json
  properties:
    renumber_residues: True
    renumber_residues_per_chain: False

step2I_checkPDB:
  tool: checking_log
  paths:
    input_pdb_path: dependency/step2H_renumberstructure/output_structure_path
    output_log_path: pdbStructureCheck.log
    
# Step 3-7: prepare system for minimization and MD

step3_pdb2gmx:
  paths:
    input_pdb_path: dependency/step2H_renumberstructure/output_structure_path
    output_gro_path: pdb2gmx.gro
    output_top_zip_path: pdb2gmx_top.zip
  properties:
    water_type: spce                 # spc, spce, tip3p, tip4p, tip5p, tips3p
    force_field: amber99sb-ildn      # gromos45a3, charmm27, gromos53a6, amber96, amber99, gromos43a2, gromos54a7, gromos43a1, amberGS, gromos53a5, amber99sb, amber03, amber99sb-ildn, oplsaa, amber94, amber99sb-star-ildn-mut
    ignh: False                      # Ignore hydrogens in the input structure
    # his: '0 0 0 0 0 0 0 0 0 0 0 0 0' # Histidine protonation array. 0: HID, 1: HIE, 2: HIP, 3: HIS1
    merge: False                     # Merge all chains into one molecule

step4_editconf:
  paths:
    input_gro_path: dependency/step3_pdb2gmx/output_gro_path
    output_gro_path: editconf.gro
  properties:
    box_type: dodecahedron           # cubic, triclinic, octahedron, dodecahedron
    distance_to_molecule: 1.0        # Distance of the box from the outermost atom in nm

step5_solvate:
  paths:
    input_solute_gro_path: dependency/step4_editconf/output_gro_path
    output_gro_path: solvate.gro
    input_top_zip_path: dependency/step3_pdb2gmx/output_top_zip_path
    output_top_zip_path: solvate_top.zip

step6_grompp_genion:
  paths:
    input_gro_path: dependency/step5_solvate/output_gro_path
    input_top_zip_path: dependency/step5_solvate/output_top_zip_path
    output_tpr_path: gppion.tpr
  properties:
    simulation_type: minimization
    maxwarn: 2

step7_genion:
  paths:
    input_tpr_path: dependency/step6_grompp_genion/output_tpr_path
    output_gro_path: genion.gro
    input_top_zip_path: dependency/step5_solvate/output_top_zip_path
    output_top_zip_path: genion_top.zip
  properties:
    neutral: True       # Neutralize charge of the system
    concentration: 0.05 # Concentration of ions in mols/L

# Steps 8-23: minimization and MD

step8_grompp_min:
  paths:
    input_gro_path: dependency/step7_genion/output_gro_path
    input_top_zip_path: dependency/step7_genion/output_top_zip_path
    output_tpr_path: gppmin.tpr
  properties:
    simulation_type: minimization
    mdp:
      nsteps: 100 # 10000
      emtol: 500

step9_mdrun_min:
  paths:
    input_tpr_path: dependency/step8_grompp_min/output_tpr_path
    output_trr_path: min.trr
    output_gro_path: min.gro
    output_edr_path: min.edr
    output_log_path: min.log
  # properties:
  #   gmx_path: /storage/apps/GROMACS/2019.6/INTEL/bin/gmx_mpi
  #   mpi_bin:  /storage/apps/Intel_Comp/xe_2018u3/compilers_and_libraries_2018.3.222/linux/mpi/intel64/bin/mpirun
  #   mpi_np: 320

step10_energy_min:
  paths:
      input_energy_path: dependency/step9_mdrun_min/output_edr_path
      output_xvg_path: min_ene.xvg
  properties:
      terms:  ["Potential"]

step11_grompp_nvt:
  paths:
    input_gro_path: dependency/step9_mdrun_min/output_gro_path
    input_top_zip_path: dependency/step7_genion/output_top_zip_path
    output_tpr_path: gppnvt.tpr
  properties:
    simulation_type: nvt
    mdp:
      nsteps: 1000 # 50000
      dt: 0.002
      Define: -DPOSRES
      ref-t: 310 310

step12_mdrun_nvt:
  paths:
    input_tpr_path: dependency/step11_grompp_nvt/output_tpr_path
    output_trr_path: nvt.trr
    output_gro_path: nvt.gro
    output_edr_path: nvt.edr
    output_log_path: nvt.log
    output_cpt_path: nvt.cpt
  # properties:
  #  gmx_path: /storage/apps/GROMACS/2019.6/INTEL/bin/gmx_mpi
  #  mpi_bin:  /storage/apps/Intel_Comp/xe_2018u3/compilers_and_libraries_2018.3.222/linux/mpi/intel64/bin/mpirun
  #  mpi_np: 320

step13_energy_nvt:
  paths:
      input_energy_path: dependency/step12_mdrun_nvt/output_edr_path
      output_xvg_path: nvt_temp.xvg
  properties:
      terms:  ["Temperature"]

step14_grompp_npt:
  paths:
    input_gro_path: dependency/step12_mdrun_nvt/output_gro_path
    input_top_zip_path: dependency/step7_genion/output_top_zip_path
    output_tpr_path: gppnpt.tpr
    input_cpt_path: dependency/step12_mdrun_nvt/output_cpt_path
  properties:
    simulation_type: npt
    mdp:
      nsteps: 1000 # 50000
      ref-t: 310 310

step15_mdrun_npt:
  paths:
    input_tpr_path: dependency/step14_grompp_npt/output_tpr_path
    output_trr_path: npt.trr
    output_gro_path: npt.gro
    output_edr_path: npt.edr
    output_log_path: npt.log
    output_cpt_path: npt.cpt
  # properties:
  #  gmx_path: /storage/apps/GROMACS/2019.6/INTEL/bin/gmx_mpi
  #  mpi_bin:  /storage/apps/Intel_Comp/xe_2018u3/compilers_and_libraries_2018.3.222/linux/mpi/intel64/bin/mpirun
  #  mpi_np: 320

step16_energy_npt:
  paths:
      input_energy_path: dependency/step15_mdrun_npt/output_edr_path
      output_xvg_path: npt_den_press.xvg
  properties:
      terms:  ["Pressure","Density"]

step17_grompp_md:
  paths:
    input_gro_path: dependency/step15_mdrun_npt/output_gro_path
    input_top_zip_path: dependency/step7_genion/output_top_zip_path
    output_tpr_path: gppmd.tpr
    input_cpt_path: dependency/step15_mdrun_npt/output_cpt_path
  properties:
    simulation_type: free
    mdp:
      nsteps : 1000 # 50000000
      ref-t: 310 310
      nstxout: 100 # 100000
      nstxout-compressed: 100 # 100000
      nstvout: 0
      nstfout: 0

step18_mdrun_md:
  paths:
    input_tpr_path: dependency/step17_grompp_md/output_tpr_path
    output_trr_path: md.trr
    output_gro_path: md.gro
    output_edr_path: md.edr
    output_log_path: md.log
    output_cpt_path: md.cpt
  #properties:
  #  gmx_path: /storage/apps/GROMACS/2019.6/INTEL/bin/gmx_mpi
  #  mpi_bin:  /storage/apps/Intel_Comp/xe_2018u3/compilers_and_libraries_2018.3.222/linux/mpi/intel64/bin/mpirun
  #  mpi_np: 320

step19_rmsfirst:
  paths:
      input_structure_path: dependency/step17_grompp_md/output_tpr_path
      input_traj_path: dependency/step18_mdrun_md/output_trr_path
      output_xvg_path: md_rmsdfirst.xvg
  properties:
      selection: Backbone

step20_rmsexp:
  paths:
      input_structure_path: dependency/step8_grompp_min/output_tpr_path
      input_traj_path: dependency/step18_mdrun_md/output_trr_path
      output_xvg_path: md_rmsdexp.xvg
  properties:
      selection: Backbone

step21_rgyr:
  paths:
      input_structure_path: dependency/step17_grompp_md/output_tpr_path
      input_traj_path: dependency/step18_mdrun_md/output_trr_path
      output_xvg_path: md_rgyr.xvg
  properties:
      selection: Backbone

step22_image:
  paths:
      input_traj_path: dependency/step18_mdrun_md/output_trr_path
      input_top_path: dependency/step17_grompp_md/output_tpr_path
      output_traj_path: imaged_traj.trr
  properties:
      center_selection: Protein
      output_selection: Protein
      pbc: mol
      center : True

step23_dry:
  paths:
      input_structure_path: dependency/step15_mdrun_npt/output_gro_path
      input_top_path: dependency/step17_grompp_md/output_tpr_path
      output_str_path: imaged_structure.gro
  properties:
      selection: Protein

step24_trjcat:
  paths:
    input_trj_zip_path: all_trajectories.zip
    output_trj_path: all_trajectories.trr
    

